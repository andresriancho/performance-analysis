<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Performance analysis report</title>

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-7s5uDGW3AHqw6xtJmNNtr+OBRJUlgkNJEo78P4b0yRw= sha512-nNo+yCHEyn0smMxSswnf/OnX6/KwJuZTlNZBjauKhTK0c+zT+q5JOCx0UFhXQ6rJR9jg6Es8gPuD2uZcYDLqSw==" crossorigin="anonymous">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha256-KXn5puMvxCw+dAYznun+drMdG1IFl3agK0p/pqT9KAo= sha512-2e8qq0ETcfWRI4HJBzQiA3UoyFk6tbNyG+qSaIBZLyW9Xf3sWZHN/lxe9fTh1U45DpPf07yj94KsUHHWe4Yk1A==" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    </head>

    <style>
        /* Damn navbar makes me pad the body
           https://stackoverflow.com/questions/10336194/twitter-bootstrap-top-nav-bar-blocking-top-content-of-the-page
        */
        body {
           padding-top: 65px;
        }

        .chart-legend li span{
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
        }
    </style>

    <script>
        // Convert Hex color to RGB
        function convertHex(hex, opacity){
            hex = hex.replace('#','');
            r = parseInt(hex.substring(0,2), 16);
            g = parseInt(hex.substring(2,4), 16);
            b = parseInt(hex.substring(4,6), 16);

            // Add Opacity to RGB to obtain RGBA
            return 'rgba('+r+','+g+','+b+','+opacity/100+')';
        }
    </script>

    <body>
        <nav class="navbar navbar-inverse navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">Performance analysis</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#memory">Memory</a></li>
                <li><a href="#network">Network</a></li>
              </ul>
            </div>
          </div>
        </nav>

        <div class="row" id="summary">
            <div class="col-md-8 col-md-offset-2">
                <h3>Revision summary</h3>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Input directory</th>
                            <th>w3af revision</th>
                            <th>w3af revision date</th>
                            <th>collector revision</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for revision in collector_data.keys() %}
                            <tr>
                                <td>{{ collector_data[revision]['meta-data']['directory'] }}</td>
                                <td><a href="https://github.com/andresriancho/w3af/commit/{{ collector_data[revision]['meta-data']['revision'] }}">{{ collector_data[revision]['meta-data']['revision'] }}</a></td>
                                <td>{{ collector_data[revision]['meta-data']['revision-date'] }}</td>
                                <td><a href="https://github.com/andresriancho/collector/commit/{{ collector_data[revision]['meta-data']['collector-revision'][:7] }}">{{ collector_data[revision]['meta-data']['collector-revision'][:7] }}</a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>


        <div class="row" id="memory">
            <div class="col-md-6 col-md-offset-2">
                <h3>PSUtil memory usage</h3>
                <p>
                    Shows the RSS (in MB) used by the main w3af process as captured by psutil library.
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-md-offset-2">
                <canvas id="PSUtilLineChart" width="800" height="400"></canvas>
            </div>
            <div class="col-md-2">
                <div id="PSUtilLineChart-legend" class="chart-legend"></div>
            </div>

            <script>
                var colors = d3.scale.category10();

                var data = {
                    labels: {{ max_items_count(collector_data, 'PSUtils memory usage summary') }},
                    datasets: [
                        {% for revision in collector_data.keys() %}
                            {
                                label: "{{ revision }}",
                                fillColor: convertHex(colors({{ loop.index }}), 20),
                                strokeColor: colors({{ loop.index }}),
                                pointColor: colors({{ loop.index }}),
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(220,220,220,1)",
                                data: {{ collector_data[revision]['PSUtils memory usage summary'] }}
                            },
                        {% endfor %}
                    ]
                };

                var options = {
                    multiTooltipTemplate: "<%=datasetLabel%> : <%= value %>",
                    responsive: true,
                    scaleLabel: "<%=value%> MB"
                };

                // Get the context of the canvas element we want to select
                var ctx = document.getElementById("PSUtilLineChart").getContext("2d");
                var PSUtilLineChart = new Chart(ctx).Line(data);

                // Legend
                document.getElementById('PSUtilLineChart-legend').innerHTML = PSUtilLineChart.generateLegend();
            </script>
        </div>
    </body>
</html>